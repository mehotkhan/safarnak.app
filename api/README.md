# API Folder Structure

This folder contains all client-side API code, including GraphQL hooks, Apollo Client setup, and utilities.

## Files Overview (7 files total)

### Auto-Generated (Codegen - Never Edit Manually)
- **`hooks.ts`** - Auto-generated React Apollo hooks from GraphQL operations
  - ⚠️ **NEVER EDIT** - Regenerated by `yarn codegen`
  - Contains: `useMeQuery`, `useGetTripsQuery`, `useLoginMutation`, etc.

- **`types.ts`** - Auto-generated TypeScript types from GraphQL schema
  - ⚠️ **NEVER EDIT** - Regenerated by `yarn codegen`
  - Contains all GraphQL types, interfaces, and enums

### Core Functionality
- **`enhanced-hooks.ts`** - Wraps auto-generated hooks with automatic Drizzle sync
  - ✅ **This is what you import and use** - All hooks from `@api` use this
  - Automatically syncs Apollo cache → Drizzle after queries/mutations
  - Provides offline capabilities without additional code

- **`client.ts`** - Apollo Client configuration + SQLite storage (merged)
  - Sets up GraphQL endpoint, auth link, cache persistence
  - Contains SQLite adapter for Apollo cache persistence
  - Configures Apollo → Drizzle sync on startup
  - Exports: `client`, `sqliteStorage`

- **`utils.ts`** - All utilities, types, and helpers (merged)
  - API types: `ApiError`, `ApiResponse`, `AuthTokens`, `ApiConfig`
  - Storage utilities: `getStoredToken`, `storeUserData`, `clearUserData`
  - Error handling: `formatApiError`, `isNetworkError`, `shouldRetryRequest`
  - Logout: `clearAllUserData` (clears AsyncStorage, SQLite, Apollo cache)

### TypeScript Support
- **`globals.d.ts`** - Global type declarations
  - Provides type bridges for generated code
  - Ensures TypeScript compatibility

### Main Export
- **`index.ts`** - Main entry point
  - Exports all hooks (enhanced versions with Drizzle sync)
  - Exports types, utilities, and Apollo client
  - **Import everything from here:** `import { useMeQuery, client } from '@api'`

## Usage

### ✅ Correct Usage (Enhanced Hooks with Auto Drizzle Sync)

```typescript
import { useMeQuery, useGetTripsQuery, useLoginMutation } from '@api';

// These hooks automatically sync to Drizzle after completion
const { data } = useMeQuery();
const { data: trips } = useGetTripsQuery({ variables: { status: 'active' } });
const [login] = useLoginMutation();
```

### ❌ Wrong Usage (Don't Import Directly)

```typescript
// Don't import from hooks.ts directly - use enhanced version
import { useMeQuery } from '@api/hooks'; // ❌ Missing Drizzle sync
```

## File Organization

**7 files total** - Optimized structure:

1. **Auto-generated (2)**: `hooks.ts`, `types.ts` - Cannot be merged (required by codegen)
2. **Core (3)**: `enhanced-hooks.ts`, `client.ts` (includes SQLite), `index.ts`
3. **Utilities (1)**: `utils.ts` - Merged: types, storage, errors, logout
4. **Support (1)**: `globals.d.ts` - TypeScript declarations

**Merged files:**
- `sqlite-storage.ts` → merged into `client.ts`
- `api-types.ts` → merged into `utils.ts`
- `logout.ts` → merged into `utils.ts`

## GraphQL Query System

### Architecture Overview

The GraphQL query system follows a **codegen-first** approach with automatic offline support:

```
GraphQL Operations (graphql/queries/*.graphql)
    ↓
GraphQL Codegen (yarn codegen)
    ↓
Auto-Generated Hooks (api/hooks.ts)
    ↓
Enhanced Hooks Wrapper (api/enhanced-hooks.ts)
    ↓
Apollo Client (network layer)
    ↓
Apollo Cache (normalized in-memory)
    ↓
SQLite Cache (persisted Apollo cache)
    ↓
Drizzle Database (structured SQL database)
```

### How It Works

1. **Define Operations**: Create `.graphql` files in `graphql/queries/`
   ```graphql
   query GetTrips($status: String) {
     getTrips(status: $status) {
       id
       destination
       status
     }
   }
   ```

2. **Code Generation**: Run `yarn codegen`
   - Reads `graphql/schema.graphql` and `graphql/queries/*.graphql`
   - Generates TypeScript types in `api/types.ts`
   - Generates React Apollo hooks in `api/hooks.ts`

3. **Enhanced Hooks**: Auto-wrapped with Drizzle sync
   - `enhanced-hooks.ts` wraps all generated hooks
   - Automatically syncs Apollo cache → Drizzle after queries/mutations
   - Provides seamless offline support

4. **Usage**: Import and use - that's it!
   ```typescript
   import { useGetTripsQuery } from '@api';
   const { data, loading } = useGetTripsQuery({ variables: { status: 'active' } });
   ```

### Generated Hooks

For each GraphQL operation, codegen creates:

- **Query hooks**: `useXxxQuery`, `useXxxLazyQuery`, `useXxxSuspenseQuery`
- **Mutation hooks**: `useXxxMutation`
- **Types**: Full TypeScript types for all operations

Example: `getTrips.graphql` → `useGetTripsQuery`, `useGetTripsLazyQuery`, etc.

## Offline Database System

### Architecture

The offline system uses a **two-layer caching strategy**:

1. **Apollo Cache** (Normalized JSON cache)
   - Fast in-memory cache
   - Persisted to SQLite (`apollo_cache.db`)
   - Used by Apollo Client for quick reads

2. **Drizzle Database** (Structured SQL database)
   - Full SQLite database (`safarnak_local.db`)
   - Structured tables: `cached_users`, `cached_trips`, etc.
   - Enables complex SQL queries for offline data

### Data Flow

```
User Action → Enhanced Hook → Apollo Client
                                    ↓
                            Network Request (if online)
                                    ↓
                            Apollo Normalized Cache
                                    ↓
                            SQLite Persistence (apollo_cache.db)
                                    ↓
                            Auto-Sync to Drizzle (safarnak_local.db)
                                    ↓
                            Available for SQL Queries
```

### Automatic Sync

The sync happens automatically:

1. **On App Startup**:
   - Apollo cache loads from SQLite persistence
   - Initial sync: Apollo cache → Drizzle database

2. **After Every Query/Mutation**:
   - Enhanced hooks automatically trigger sync
   - Apollo cache → Drizzle (background, non-blocking)

3. **Sync Process**:
   - Extracts entities from Apollo cache (e.g., `User:123`, `Trip:456`)
   - Transforms GraphQL data to Drizzle schema format
   - Upserts into appropriate cached tables (`cached_users`, `cached_trips`, etc.)
   - Updates sync metadata (`cachedAt`, `lastSyncAt`)

### Database Schema

**Apollo Cache Table** (`apollo_cache.db`):
- `key` - Apollo cache key (e.g., `"User:123"`)
- `value` - Normalized JSON data
- `updated_at` - Timestamp

**Drizzle Cached Tables** (`safarnak_local.db`):
- `cached_users` - User entities with sync metadata
- `cached_trips` - Trip entities with sync metadata
- `cached_messages` - Message entities with sync metadata
- `cached_tours` - Tour entities with sync metadata
- `cached_places` - Place entities with sync metadata
- `pending_mutations` - Queued mutations for offline
- `sync_metadata` - Sync status per entity type

Each cached table includes:
- All base entity fields (from shared schema)
- `cachedAt` - When entity was cached
- `lastSyncAt` - Last sync timestamp
- `pending` - Boolean flag for pending changes

### Offline Capabilities

1. **Offline Queries**:
   - Apollo cache serves data immediately (from SQLite)
   - Drizzle database enables complex SQL queries
   - No network required for cached data

2. **Offline Mutations**:
   - Mutations are queued in `pending_mutations` table
   - Automatically synced when connection restored
   - Optimistic updates via Apollo cache

3. **Data Persistence**:
   - Data survives app restarts
   - Both Apollo cache and Drizzle data persist
   - Automatic sync ensures consistency

### Querying Offline Data

**Apollo Cache (Simple)**:
```typescript
import { client } from '@api';
const cache = client.cache.extract();
const user = cache['User:123']; // Direct access
```

**Drizzle Database (SQL Queries)**:
```typescript
import { getLocalDB, cachedTrips } from '@drizzle/client';
import { eq, and, desc } from 'drizzle-orm';

const db = await getLocalDB();
const trips = await db
  .select()
  .from(cachedTrips)
  .where(and(
    eq(cachedTrips.userId, '123'),
    eq(cachedTrips.status, 'active')
  ))
  .orderBy(desc(cachedTrips.createdAt));
```

### System Status

View real-time offline system status:
- Network connectivity
- Backend reachability
- Cache statistics (size, entity counts)
- Sync status per entity type
- Pending mutations count

Access via: Profile → System Status

## Workflow

### Adding New GraphQL Operations

1. **Define Operation**: Add `.graphql` file to `graphql/queries/`
   ```graphql
   query GetTour($id: ID!) {
     getTour(id: $id) {
       id
       title
       price
     }
   }
   ```

2. **Generate Code**: Run `yarn codegen`
   ```bash
   yarn codegen
   ```
   - Updates `api/hooks.ts` with `useGetTourQuery`
   - Updates `api/types.ts` with TypeScript types

3. **Use Enhanced Hook**: Import and use
   ```typescript
   import { useGetTourQuery } from '@api';
   
   const { data, loading } = useGetTourQuery({ 
     variables: { id: '123' } 
   });
   // ✅ Automatically syncs to Drizzle after query completes
   ```

4. **That's It!** - No manual sync code needed

### Data Access Patterns

**Online (Default)**:
```typescript
// Fetches from network, caches, and syncs to Drizzle
const { data } = useGetTripsQuery();
```

**Offline (Automatic Fallback)**:
```typescript
// Uses Apollo cache (from SQLite) if offline
// Still works - no code changes needed
const { data } = useGetTripsQuery();
```

**Local-First Query (Advanced)**:
```typescript
import { getLocalDB, cachedTrips } from '@drizzle/client';

const db = await getLocalDB();
const localTrips = await db.select().from(cachedTrips);
// Query local database directly (SQL queries)
```

## Benefits

### GraphQL Query System
- ✅ **Type Safety**: Full TypeScript types from schema
- ✅ **Auto-Generated**: No manual hook creation
- ✅ **Consistent API**: Same pattern for all operations
- ✅ **Apollo Integration**: Leverages Apollo Client features

### Offline Database System
- ✅ **Automatic Sync**: No manual sync code needed
- ✅ **Two-Layer Cache**: Fast Apollo + SQL-queryable Drizzle
- ✅ **Offline Support**: Works completely offline
- ✅ **SQL Queries**: Complex queries on cached data
- ✅ **Data Persistence**: Survives app restarts
- ✅ **Real-Time Stats**: Monitor cache and sync status

## Technical Details

### Sync Triggers

1. **App Initialization**: 
   - Loads persisted Apollo cache
   - Syncs to Drizzle once on startup

2. **After Queries**: 
   - Enhanced hooks trigger sync on `onCompleted`
   - Background process, doesn't block UI

3. **After Mutations**: 
   - Enhanced mutation hooks trigger sync
   - Ensures mutations are cached for offline access

### Sync Performance

- **Non-Blocking**: Syncs happen in background
- **Incremental**: Only processes changed entities
- **Efficient**: Uses upsert operations (insert or update)
- **Error Handling**: Fails gracefully, logs warnings

### Storage Sizes

- **Apollo Cache**: Up to 10MB (configurable)
- **Drizzle Database**: Unlimited (SQLite)
- **AsyncStorage**: Fallback for web platform

