# API Folder Structure

This folder contains all client-side API code, including GraphQL hooks, Apollo Client setup, cache storage, and utilities.

## Files Overview (6 files total)

### Auto-Generated (Codegen - Never Edit Manually)
- **`hooks.ts`** - Auto-generated React Apollo hooks from GraphQL operations
  - ⚠️ **NEVER EDIT** - Regenerated by `yarn codegen`
  - Contains: `useMeQuery`, `useGetTripsQuery`, `useLoginMutation`, etc.

- **`types.ts`** - Auto-generated TypeScript types from GraphQL schema
  - ⚠️ **NEVER EDIT** - Regenerated by `yarn codegen`
  - Contains all GraphQL types, interfaces, and enums

### Core Functionality
- **`client.ts`** - Apollo Client configuration
  - Sets up GraphQL endpoint, auth link, WebSocket subscriptions
  - Configures cache persistence via DrizzleCacheStorage
  - Exports: `client`

- **`cache-storage.ts`** - Drizzle-based Apollo cache storage (Expo SQLite)
  - Implements Apollo's `PersistentStorage` interface
  - Uses Drizzle ORM with Expo SQLite
  - Automatically syncs to structured tables (cachedUsers, cachedTrips, etc.)
  - Exports: `drizzleCacheStorage`, `DrizzleCacheStorage`

- **`utils.ts`** - All utilities, types, and helpers
  - API types: `ApiError`, `ApiResponse`, `AuthTokens`, `ApiConfig`
  - Storage utilities: `getStoredToken`, `storeUserData`, `clearUserData`
  - Error handling: `formatApiError`, `isNetworkError`, `shouldRetryRequest`
  - Logout: `clearAllUserData` (clears AsyncStorage, Drizzle cache, Apollo cache)

### TypeScript Support
- **`globals.d.ts`** - Global type declarations
  - Provides type bridges for generated code
  - Ensures TypeScript compatibility

### Main Export
- **`index.ts`** - Main entry point
  - Exports all auto-generated hooks (directly from hooks.ts)
  - Exports types, utilities, Apollo client, and cache storage
  - **Import everything from here:** `import { useMeQuery, client } from '@api'`

## Usage

### ✅ Correct Usage (Auto-Generated Hooks with Automatic Drizzle Sync)

```typescript
import { useMeQuery, useGetTripsQuery, useLoginMutation } from '@api';

// DrizzleCacheStorage automatically syncs Apollo cache → Drizzle on every write
const { data } = useMeQuery();
const { data: trips } = useGetTripsQuery({ variables: { status: 'active' } });
const [login] = useLoginMutation();
```

### Direct Cache Storage Access

```typescript
import { drizzleCacheStorage } from '@api';

// Get cache statistics
const size = await drizzleCacheStorage.getCacheSize();
const keys = await drizzleCacheStorage.getAllKeys();

// Clear cache if needed
await drizzleCacheStorage.clearAll();
```

## File Organization

**6 files total** - Clean structure:

1. **Auto-generated (2)**: `hooks.ts`, `types.ts` - Cannot be merged (required by codegen)
2. **Core (3)**: `client.ts`, `cache-storage.ts`, `index.ts`
3. **Utilities (1)**: `utils.ts` - Types, storage, errors, logout
4. **Support (1)**: `globals.d.ts` - TypeScript declarations

**Architecture:**
- Apollo Client (`client.ts`) uses DrizzleCacheStorage (`cache-storage.ts`) for persistence
- Cache storage automatically syncs to structured Drizzle tables (no wrapper hooks needed)
- All hooks are used directly from auto-generated `hooks.ts`

## GraphQL Query System

### Architecture Overview

The GraphQL query system follows a **codegen-first** approach with automatic offline support:

```
GraphQL Operations (graphql/queries/*.graphql)
    ↓
GraphQL Codegen (yarn codegen)
    ↓
Auto-Generated Hooks (api/hooks.ts)
    ↓
Apollo Client (network layer)
    ↓
Apollo Cache (normalized in-memory)
    ↓
DrizzleCacheStorage (api/cache-storage.ts)
    ↓
Drizzle ORM + Expo SQLite (safarnak_local.db)
    ├─→ apollo_cache_entries (raw cache)
    └─→ cached_users, cached_trips, etc. (structured tables)
```

### How It Works

1. **Define Operations**: Create `.graphql` files in `graphql/queries/`
   ```graphql
   query GetTrips($status: String) {
     getTrips(status: $status) {
       id
       destination
       status
     }
   }
   ```

2. **Code Generation**: Run `yarn codegen`
   - Reads `graphql/schema.graphql` and `graphql/queries/*.graphql`
   - Generates TypeScript types in `api/types.ts`
   - Generates React Apollo hooks in `api/hooks.ts`

3. **Cache Storage**: DrizzleCacheStorage handles persistence
   - `cache-storage.ts` implements Apollo's PersistentStorage interface
   - Automatically syncs Apollo cache → Drizzle on every write
   - Uses Expo SQLite via Drizzle ORM
   - Provides seamless offline support

4. **Usage**: Import and use - that's it!
   ```typescript
   import { useGetTripsQuery } from '@api';
   const { data, loading } = useGetTripsQuery({ variables: { status: 'active' } });
   ```

### Generated Hooks

For each GraphQL operation, codegen creates:

- **Query hooks**: `useXxxQuery`, `useXxxLazyQuery`, `useXxxSuspenseQuery`
- **Mutation hooks**: `useXxxMutation`
- **Types**: Full TypeScript types for all operations

Example: `getTrips.graphql` → `useGetTripsQuery`, `useGetTripsLazyQuery`, etc.

## Offline Database System

### Architecture

The offline system uses a **unified Drizzle storage**:

1. **Apollo Cache** (Normalized in-memory cache)
   - Fast in-memory cache
   - Used by Apollo Client for quick reads

2. **DrizzleCacheStorage** (Expo SQLite via Drizzle ORM)
   - Single database: `safarnak_local.db`
   - Stores raw cache in `apollo_cache_entries` table
   - Automatically syncs to structured tables: `cached_users`, `cached_trips`, etc.
   - Enables complex SQL queries for offline data

### Data Flow

```
User Action → Auto-Generated Hook → Apollo Client
                                    ↓
                            Network Request (if online)
                                    ↓
                            Apollo Normalized Cache
                                    ↓
                            DrizzleCacheStorage.setItem()
                                    ↓
                            Drizzle ORM (safarnak_local.db)
                                    ├─→ apollo_cache_entries (raw cache)
                                    └─→ cached_users, cached_trips (structured)
                                    ↓
                            Available for SQL Queries
```

### Automatic Sync

The sync happens automatically on every Apollo cache write:

1. **Apollo Writes to Cache**:
   - Apollo calls `DrizzleCacheStorage.setItem(key, value)`
   - Happens automatically via `persistCache` configuration

2. **Dual Write in Single Transaction**:
   - Writes raw cache entry to `apollo_cache_entries` table
   - Extracts entity type (e.g., `User:123` → `User`)
   - Transforms and upserts to structured table (`cached_users`, etc.)
   - Updates sync metadata (`cachedAt`, `lastSyncAt`)

3. **On App Startup**:
   - Apollo cache restores from `apollo_cache_entries` table
   - All cached data immediately available

### Database Schema

**Apollo Cache Entries** (`safarnak_local.db` → `apollo_cache_entries`):
- `key` - Apollo cache key (e.g., `"User:123"`, `"ROOT_QUERY"`)
- `value` - Normalized JSON data
- `entity_type` - Extracted __typename (null for ROOT_QUERY, etc.)
- `entity_id` - Extracted ID (null for ROOT_QUERY, etc.)
- `updated_at` - Timestamp

**Drizzle Cached Tables** (`safarnak_local.db`):
- `cached_users` - User entities with sync metadata
- `cached_profiles` - Profile entities with sync metadata (Phase 11.4)
- `cached_trips` - Trip entities with sync metadata (includes hosted trips via isHosted flag)
- `cached_trip_participants` - Trip participant entities (Phase 12)
- `cached_trip_days` - Trip day entities (Phase 12)
- `cached_trip_items` - Trip item entities (Phase 12)
- `cached_messages` - Message entities with sync metadata
- `cached_places` - Place entities with sync metadata
- `pending_mutations` - Queued mutations for offline
- `sync_metadata` - Sync status per entity type

Each cached table includes:
- All base entity fields (from shared schema)
- `cachedAt` - When entity was cached
- `lastSyncAt` - Last sync timestamp
- `pending` - Boolean flag for pending changes

### Offline Capabilities

1. **Offline Queries**:
   - Apollo cache serves data immediately (from SQLite)
   - Drizzle database enables complex SQL queries
   - No network required for cached data

2. **Offline Mutations**:
   - Mutations are queued in `pending_mutations` table
   - Automatically synced when connection restored
   - Optimistic updates via Apollo cache

3. **Data Persistence**:
   - Data survives app restarts
   - Single database ensures consistency
   - Automatic dual-write (raw + structured) on every cache update

### Querying Offline Data

**Apollo Cache (Simple)**:
```typescript
import { client } from '@api';
const cache = client.cache.extract();
const user = cache['User:123']; // Direct access
```

**Drizzle Database (SQL Queries)**:
```typescript
import { getLocalDB, cachedTrips } from '@database/client';
import { eq, and, desc } from 'drizzle-orm';

const db = await getLocalDB();
const trips = await db
  .select()
  .from(cachedTrips)
  .where(and(
    eq(cachedTrips.userId, '123'),
    eq(cachedTrips.status, 'active')
  ))
  .orderBy(desc(cachedTrips.createdAt));
```

### System Status

View real-time offline system status:
- Network connectivity
- Backend reachability
- Cache statistics (size, entity counts)
- Sync status per entity type
- Pending mutations count

Access via: Profile → System Status

## Workflow

### Adding New GraphQL Operations

1. **Define Operation**: Add `.graphql` file to `graphql/queries/`
   ```graphql
   query GetTour($id: ID!) {
     getTour(id: $id) {
       id
       title
       price
     }
   }
   ```

2. **Generate Code**: Run `yarn codegen`
   ```bash
   yarn codegen
   ```
   - Updates `api/hooks.ts` with `useGetTourQuery`
   - Updates `api/types.ts` with TypeScript types

3. **Use Hook**: Import and use directly
   ```typescript
   import { useGetTourQuery } from '@api';
   
   const { data, loading } = useGetTourQuery({ 
     variables: { id: '123' } 
   });
   // ✅ DrizzleCacheStorage automatically syncs on every cache write
   ```

4. **That's It!** - No manual sync code needed

### Data Access Patterns

**Online (Default)**:
```typescript
// Fetches from network, caches, and syncs to Drizzle
const { data } = useGetTripsQuery();
```

**Offline (Automatic Fallback)**:
```typescript
// Uses Apollo cache (from SQLite) if offline
// Still works - no code changes needed
const { data } = useGetTripsQuery();
```

**Local-First Query (Advanced)**:
```typescript
import { getLocalDB, cachedTrips } from '@database/client';

const db = await getLocalDB();
const localTrips = await db.select().from(cachedTrips);
// Query local database directly (SQL queries)
```

## Benefits

### GraphQL Query System
- ✅ **Type Safety**: Full TypeScript types from schema
- ✅ **Auto-Generated**: No manual hook creation
- ✅ **Consistent API**: Same pattern for all operations
- ✅ **Apollo Integration**: Leverages Apollo Client features

### Offline Database System
- ✅ **Automatic Sync**: No manual sync code needed
- ✅ **Two-Layer Cache**: Fast Apollo + SQL-queryable Drizzle
- ✅ **Offline Support**: Works completely offline
- ✅ **SQL Queries**: Complex queries on cached data
- ✅ **Data Persistence**: Survives app restarts
- ✅ **Real-Time Stats**: Monitor cache and sync status

## Technical Details

### Sync Triggers

1. **Every Cache Write**: 
   - Apollo calls `DrizzleCacheStorage.setItem()` automatically
   - Happens on every query/mutation response
   - No wrapper hooks or manual triggers needed

2. **App Initialization**: 
   - Apollo restores cache from `apollo_cache_entries` table
   - All cached data immediately available

3. **Automatic & Transparent**: 
   - No manual sync code required
   - Works seamlessly with all Apollo operations

### Sync Performance

- **Non-Blocking**: Syncs happen in background
- **Incremental**: Only processes changed entities
- **Efficient**: Uses upsert operations (insert or update)
- **Error Handling**: Fails gracefully, logs warnings

### Storage Sizes

- **Apollo Cache**: Up to 10MB (configurable)
- **Drizzle Database**: Unlimited (SQLite)
- **AsyncStorage**: Fallback for web platform

