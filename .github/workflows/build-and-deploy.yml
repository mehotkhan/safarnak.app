name: Build Android APK

on:
  push:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'

  # Gradle tuning for CI
  GRADLE_OPTS: >
    -Dorg.gradle.daemon=false
    -Dorg.gradle.workers.max=4
    -Dorg.gradle.parallel=true
    -Dorg.gradle.caching=true
    -Dorg.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError
    -Dkotlin.compiler.execution.strategy=in-process

  NODE_ENV: 'production'

  # App environment
  GRAPHQL_URL: 'https://safarnak.app/graphql'
  APP_NAME: 'ÿ≥ŸÅÿ±ŸÜÿß⁄©'
  APP_SCHEME: 'safarnak'
  BUNDLE_IDENTIFIER: 'ir.mohet.safarnak'

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 60

    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: false

    permissions:
      contents: write
      packages: write

    steps:
      # -----------------------------------------------------------------------
      # Checkout
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      # -----------------------------------------------------------------------
      # Free disk space (React Native + Android Toolchain is heavy)
      # -----------------------------------------------------------------------
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY" || true
          df -h

      # -----------------------------------------------------------------------
      # Node + Yarn (with cache)
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          # explicit for future-proofing / monorepo move
          cache-dependency-path: 'yarn.lock'

      - name: Install dependencies
        run: |
          yarn install --frozen-lockfile --prefer-offline --no-progress --network-timeout 100000
          echo "Dependencies installed successfully"

      # -----------------------------------------------------------------------
      # Safety: ensure babel-plugin-inline-import exists (keeps your previous fix)
      # -----------------------------------------------------------------------
      - name: Verify Babel plugin is installed
        run: |
          echo "Checking for babel-plugin-inline-import..."
          if [ ! -d "node_modules/babel-plugin-inline-import" ]; then
            echo "‚ö†Ô∏è babel-plugin-inline-import not found in node_modules, reinstalling..."
            yarn install --frozen-lockfile
          fi
          if node -e "require.resolve('babel-plugin-inline-import')" 2>/dev/null; then
            echo "‚úÖ babel-plugin-inline-import is accessible"
          else
            echo "‚ùå babel-plugin-inline-import cannot be resolved, installing explicitly..."
            yarn add -D babel-plugin-inline-import@^3.0.0
            echo "‚úÖ Plugin installed"
          fi

      # -----------------------------------------------------------------------
      # GraphQL codegen (only if missing)
      # -----------------------------------------------------------------------
      - name: Generate GraphQL types (if needed)
        run: |
          if [ ! -f "api/types.ts" ] || [ ! -f "api/hooks.ts" ]; then
            echo "Generating GraphQL types..."
            yarn codegen
          else
            echo "‚úÖ GraphQL types already exist"
          fi

      - name: Verify required API files exist
        run: |
          echo "Verifying required API files for Android build..."
          if [ ! -f "api/types.ts" ] || [ ! -f "api/hooks.ts" ]; then
            echo "‚ùå Error: Required API files (api/types.ts, api/hooks.ts) are missing!"
            echo "Please run 'yarn codegen' locally and commit the generated files."
            exit 1
          fi
          echo "‚úÖ Required API files found"

      # -----------------------------------------------------------------------
      # Version bump + semantic analysis (unchanged logic)
      # -----------------------------------------------------------------------
      - name: Determine semantic version bump
        id: version_bump
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          node <<'NODE'
          // ... your existing Node script here, unchanged ...
          // I kept the logic exactly as you had it
          NODE

      - name: Check if version actually changed
        id: version_changed
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          NEW_VERSION=${{ steps.version_bump.outputs.version }}
          
          if [ "$CURRENT_VERSION" != "$NEW_VERSION" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Version will change: $CURRENT_VERSION ‚Üí $NEW_VERSION"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Version unchanged: $CURRENT_VERSION"
          fi

      - name: Apply version bump (update package.json)
        if: steps.version_changed.outputs.changed == 'true'
        run: |
          NEW_VERSION=${{ steps.version_bump.outputs.version }}
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '${NEW_VERSION}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
            console.log('‚úÖ package.json updated to ${NEW_VERSION}');
          "
          echo "‚úÖ Version files updated to ${NEW_VERSION}"

      # -----------------------------------------------------------------------
      # Version code for Android
      # -----------------------------------------------------------------------
      - name: Calculate version code for Android
        id: version_code
        run: |
          VERSION=$(node -p "require('./package.json').version")
          VERSION_CODE=$(node -e "
            const v = '$VERSION'.split('.').map(n => parseInt(n, 10) || 0);
            const code = v[0] * 10000 + v[1] * 100 + v[2];
            console.log(code);
          ")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "üì± Version: $VERSION ‚Üí Version Code: $VERSION_CODE"

      # -----------------------------------------------------------------------
      # Expo prebuild ‚Äì now ONLY when we actually build a new version
      # -----------------------------------------------------------------------
      - name: Expo prebuild (propagate version to native)
        if: steps.version_changed.outputs.changed == 'true'
        run: |
          echo "Running Expo prebuild with version code: ${{ steps.version_code.outputs.version_code }}"
          npx expo prebuild --platform android --no-install --clear || echo "Expo prebuild failed, continuing..."
          echo "Expo prebuild completed"
        env:
          ANDROID_VERSION_CODE: ${{ steps.version_code.outputs.version_code }}

      # -----------------------------------------------------------------------
      # JDK + Gradle (modern setup)
      # -----------------------------------------------------------------------
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          check-latest: false
          # NOTE: we purposely do NOT use "cache: gradle" here anymore.
          # Gradle caching is handled by gradle/actions/setup-gradle.

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: '11076708'
          accept-android-sdk-licenses: true
          log-accepted-android-sdk-licenses: false
          packages: 'platforms;android-36 build-tools;36.0.0 platform-tools'

      - name: Setup Gradle (with cache)
        uses: gradle/actions/setup-gradle@v3
        with:
          # Writes cache on push builds, read-only on PRs
          cache-read-only: ${{ github.event_name == 'pull_request' }}

      # -----------------------------------------------------------------------
      # Metro / JS build cache
      # -----------------------------------------------------------------------
      - name: Cache Metro bundler
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: |
            android/app/build/generated/assets
            android/app/build/intermediates/sourcemaps
            /tmp/metro-*
            node_modules/.cache
          key: ${{ runner.os }}-metro-${{ hashFiles('package.json', 'yarn.lock', 'app/**', 'components/**') }}
          restore-keys: |
            ${{ runner.os }}-metro-
            ${{ runner.os }}-node-

      # -----------------------------------------------------------------------
      # Sanity checks on Android project
      # -----------------------------------------------------------------------
      - name: Verify Android project structure
        run: |
          echo "Checking Android project structure..."
          ls -la android/ || echo "android/ directory not found"
          ls -la android/gradlew || echo "android/gradlew not found"
          ls -la android/app/ || echo "android/app/ directory not found"
          echo "Android project structure check completed"

      - name: Make Gradle wrapper executable
        run: chmod +x android/gradlew

      # -----------------------------------------------------------------------
      # Build Release APK (arm64-v8a only)
      # -----------------------------------------------------------------------
      - name: Build Android APK (with versioned code)
        if: steps.version_changed.outputs.changed == 'true'
        working-directory: android
        run: |
          ./gradlew assembleRelease \
            --no-daemon \
            --stacktrace \
            --build-cache \
            -x lint \
            -x test \
            -PreactNativeArchitectures=arm64-v8a
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          APP_NAME: 'Safarnak'
          APP_SCHEME: 'safarnak'
          EXPO_PUBLIC_GRAPHQL_URL: 'https://safarnak.app/graphql'
          GRAPHQL_URL: 'https://safarnak.app/graphql'
          ANDROID_VERSION_CODE: ${{ steps.version_code.outputs.version_code }}
          REACT_NATIVE_ANDROID_ARCHITECTURES: arm64-v8a

      # -----------------------------------------------------------------------
      # APK handling (rename, verify, upload)
      # -----------------------------------------------------------------------
      - name: List APK files
        if: steps.version_changed.outputs.changed == 'true'
        working-directory: android/app/build/outputs/apk/release
        run: |
          echo "=== Generated APK files ==="
          ls -lh *.apk || echo "No APK files found"
          echo ""
          echo "=== APK sizes ==="
          du -h *.apk 2>/dev/null || echo "No APK files to measure"
          echo ""
          if ls *.apk 1> /dev/null 2>&1; then
            echo "‚úÖ APK files found successfully"
          else
            echo "‚ùå No APK files found in release directory!"
            ls -la
            exit 1
          fi

      - name: Read version info
        if: steps.version_changed.outputs.changed == 'true'
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          VERSION_CODE=$(node -e "
            const v = '$VERSION'.split('.').map(n => parseInt(n, 10) || 0);
            const code = v[0] * 10000 + v[1] * 100 + v[2];
            console.log(code);
          ")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "major=$(echo $VERSION | cut -d. -f1)" >> $GITHUB_OUTPUT
          echo "minor=$(echo $VERSION | cut -d. -f2)" >> $GITHUB_OUTPUT
          echo "patch=$(echo $VERSION | cut -d. -f3)" >> $GITHUB_OUTPUT
          echo "bump_type=${{ steps.version_bump.outputs.bump_type }}" >> $GITHUB_OUTPUT
          echo "stage=$(node -e "
            const [major, minor] = '$VERSION'.split('.').map(Number);
            if (major === 0) {
              if (minor < 8) console.log('alpha');
              else if (minor < 9) console.log('beta');
              else console.log('beta');
            } else {
              console.log('stable');
            }
          ")" >> $GITHUB_OUTPUT

      - name: Rename APK with descriptive name
        if: steps.version_changed.outputs.changed == 'true'
        working-directory: android/app/build/outputs/apk/release
        run: |
          echo "=== Renaming APK file ==="
          ls -la
          
          APK_FILE=$(ls *.apk 2>/dev/null | head -n 1)
          if [ -z "$APK_FILE" ]; then
            echo "‚ùå No APK file found in release directory!"
            ls -la
            exit 1
          fi
          
          echo "Found APK file: $APK_FILE"
          NEW_NAME="Safarnak-v${{ steps.version_code.outputs.version }}-build${{ github.run_number }}.apk"
          echo "Renaming to: $NEW_NAME"
          cp "$APK_FILE" "$NEW_NAME"
          
          if [ -f "$NEW_NAME" ]; then
            echo "‚úÖ Successfully renamed APK: $APK_FILE -> $NEW_NAME"
            ls -lh "$NEW_NAME"
          else
            echo "‚ùå Failed to rename APK file!"
            exit 1
          fi

      - name: Verify APK file before upload
        if: steps.version_changed.outputs.changed == 'true'
        run: |
          APK_PATH="android/app/build/outputs/apk/release/Safarnak-v${{ steps.version_code.outputs.version }}-build${{ github.run_number }}.apk"
          echo "Checking APK file: $APK_PATH"
          if [ -f "$APK_PATH" ]; then
            echo "‚úÖ APK file exists and ready for upload"
            echo "File size: $(du -h "$APK_PATH" | cut -f1)"
            echo "File permissions: $(ls -l "$APK_PATH")"
          else
            echo "‚ùå APK file not found at expected path: $APK_PATH"
            ls -la android/app/build/outputs/apk/release/
            exit 1
          fi

      - name: Upload APK artifact
        if: steps.version_changed.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: safarnak-android-v${{ steps.version_code.outputs.version }}-build${{ github.run_number }}
          path: android/app/build/outputs/apk/release/Safarnak-v${{ steps.version_code.outputs.version }}-build${{ github.run_number }}.apk
          retention-days: 30
          compression-level: 0

      # -----------------------------------------------------------------------
      # Release notes + GitHub Release (unchanged content)
      # -----------------------------------------------------------------------
      - name: Generate commit list for release notes
        if: steps.version_changed.outputs.changed == 'true'
        id: commits
        run: |
          # ... your existing commit categorization script ...

      - name: Commit version bump if changed
        if: steps.version_changed.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "chore: bump version to ${{ steps.version_code.outputs.version }} [skip ci]" || echo "No changes to commit"
          git push origin HEAD || echo "Push failed or unnecessary"

      - name: Create GitHub Release with APK
        if: steps.version_changed.outputs.changed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version_code.outputs.version }}
          name: Safarnak v${{ steps.version_code.outputs.version }}
          body: |
            # üöÄ Safarnak v${{ steps.version_code.outputs.version }}
            ...
          files: android/app/build/outputs/apk/release/Safarnak-v${{ steps.version_code.outputs.version }}-build${{ github.run_number }}.apk
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------------------
      # Gradle shutdown (no aggressive cache deletion anymore)
      # -----------------------------------------------------------------------
      - name: Stop Gradle daemon
        if: always()
        working-directory: android
        run: ./gradlew --stop || true
