name: Build Android APK

on:
  push:
    branches: [master, main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'
  GRADLE_OPTS: '-Dorg.gradle.daemon=true -Dorg.gradle.workers.max=4 -Dorg.gradle.parallel=true -Dorg.gradle.caching=true -Dorg.gradle.configuration-cache=true -Dorg.gradle.jvmargs=-Xmx4g -Dkotlin.compiler.execution.strategy=in-process'
  NODE_ENV: 'production'

jobs:
  build_android:
    name: Build Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile --prefer-offline

      - name: Calculate version
        id: version
        run: |
          node <<'NODE'
          const fs = require('fs');
          const cp = require('child_process');
          const pkg = JSON.parse(fs.readFileSync('package.json','utf8'));
          const current = pkg.version.trim();
          
          cp.execSync('git fetch origin --tags --force 2>/dev/null', { stdio: 'ignore' });
          
          const commitMsg = (process.env.GITHUB_EVENT_NAME === 'push') 
            ? cp.execSync('git log -1 --pretty=%B').toString().trim()
            : '';
          
          let bump = 'none';
          const msgLower = commitMsg.toLowerCase();
          if (msgLower.match(/^(feat|feature)[\(:]/)) bump = 'minor';
          else if (msgLower.match(/^(fix|bugfix)[\(:]/)) bump = 'patch';
          
          const [major, minor, patch] = current.split('.').map(Number);
          let newVersion = current;
          
          if (bump === 'minor') newVersion = `${major}.${minor + 1}.0`;
          else if (bump === 'patch') newVersion = `${major}.${minor}.${patch + 1}`;
          
          const versionCode = (major * 10000) + (minor * 100) + patch;
          
          fs.writeFileSync('package.json', JSON.stringify({...pkg, version: newVersion}, null, 2));
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `version=${newVersion}\nversionCode=${versionCode}\nbump=${bump}\n`);
          NODE

      - name: Update version in build.gradle
        run: |
          sed -i "s/versionCode [0-9]*/versionCode ${{ steps.version.outputs.versionCode }}/" android/app/build.gradle
          sed -i "s/versionName \".*\"/versionName \"${{ steps.version.outputs.version }}\"/" android/app/build.gradle

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-disabled: false
          add-job-summary: never
          arguments: |
            --configuration-cache
            --build-cache

      - name: Build APK
        run: |
          cd android
          ./gradlew assembleRelease \
            --stacktrace \
            --build-cache \
            --configuration-cache \
            --parallel \
            --max-workers=4 \
            -x lint \
            -x test \
            -PreactNativeArchitectures=arm64-v8a \
            -Pandroid.enableMinifyInReleaseBuilds=true \
            -Pandroid.enableShrinkResourcesInReleaseBuilds=true

      - name: Generate changelog
        id: changelog
        if: steps.version.outputs.bump != 'none'
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --oneline -n 10)
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --oneline)
          fi
          
          EOF_MARKER=$(openssl rand -hex 16)
          echo "commits<<${EOF_MARKER}" >> $GITHUB_OUTPUT
          echo "$COMMITS" | while IFS= read -r line; do
            HASH=$(echo "$line" | awk '{print $1}')
            MSG=$(echo "$line" | cut -d' ' -f2-)
            echo "- $MSG ($HASH)"
          done >> $GITHUB_OUTPUT
          echo "${EOF_MARKER}" >> $GITHUB_OUTPUT

      - name: Commit version bump
        if: steps.version.outputs.bump != 'none'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add package.json
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }}"
          git push

      - name: Create Release
        if: steps.version.outputs.bump != 'none'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Safarnak v${{ steps.version.outputs.version }}
          body: |
            ðŸš€ Safarnak v${{ steps.version.outputs.version }}
            
            **Build Info**
            - Version: ${{ steps.version.outputs.version }}
            - Version Code: ${{ steps.version.outputs.versionCode }}
            - Build: #${{ github.run_number }}
            - Commit: ${{ github.sha }}
            - Date: ${{ github.event.head_commit.timestamp }}
            
            **Changes**
            ${{ steps.changelog.outputs.commits }}
            
            **Installation**
            1. Download APK
            2. Enable "Install from unknown sources"
            3. Install
          files: |
            android/app/build/outputs/apk/release/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
