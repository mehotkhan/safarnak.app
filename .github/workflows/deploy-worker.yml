name: ðŸš€ Deploy Worker

on:
  push:
    branches: [master, main]
  workflow_dispatch:

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

jobs:
  deploy:
    name: âš¡ Deploy to Cloudflare Workers
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: ðŸ“¦ Install dependencies
        run: yarn install --frozen-lockfile

      - name: ðŸ—„ï¸ Setup database
        run: yarn db:migrate

      - name: ðŸ“Š Generate GraphQL types
        run: yarn codegen

      - name: âš¡ Deploy Worker
        run: |
          # Deploy with GRAPHQL_URL environment variable
          # This ensures avatar URLs use the correct base URL in production
          # If GRAPHQL_URL secret is not set, defaults to https://safarnak.app/graphql
          GRAPHQL_URL_VALUE="${GRAPHQL_URL:-https://safarnak.app/graphql}"
          wrangler deploy --config wrangler.jsonc --var GRAPHQL_URL:"${GRAPHQL_URL_VALUE}"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          GRAPHQL_URL: ${{ secrets.GRAPHQL_URL || 'https://safarnak.app/graphql' }}

      - name: ðŸ” Verify deployment
        run: |
          echo "âœ… Worker deployed successfully!"
          echo "ðŸŒ GraphQL endpoint: https://safarnak.mohet.ir/graphql"

      - name: ðŸ“Š Deployment Summary
        run: |
          echo "## âš¡ Worker Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: âœ… Successfully deployed" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "**GraphQL Endpoint**: https://safarnak.mohet.ir/graphql" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
