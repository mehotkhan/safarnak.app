type Query {
  myConversations: [Conversation!]!
  conversationMessagesPage(
    conversationId: ID!
    cursor: String
    limit: Int = 50
  ): ChatMessageConnection!
  me: User
  getUser(id: ID!): User
  getTrips(status: String, isHosted: Boolean): [Trip!]!
  getTrip(id: ID!): Trip
  getPlaces(category: String, limit: Int): [Place!]!
  getPlace(id: ID!): Place
  getLocations(limit: Int): [Location!]!
  getLocation(id: ID!): Location
  getPosts(type: String, limit: Int, offset: Int, after: String, before: String): PostsConnection!
  getPost(id: ID!): Post
  getBookmarks(type: String): [Bookmark!]!
  getAlerts: [Alert!]!
  checkUsernameAvailability(username: String!): Boolean!
  getMyDevices: [Device!]!
}

type Mutation {
  createConversation(dmWithUserId: ID, tripId: ID, title: String): Conversation!
  sendMessage(
    conversationId: ID!
    ciphertext: String!
    ciphertextMeta: JSON
    type: String = "text"
    metadata: JSON
  ): ChatMessage!
  createChatInvite(conversationId: ID!, toUserId: ID!, inviteCiphertext: String!): Boolean!
  ackChatInvite(inviteId: ID!, acceptCiphertext: String!): Boolean!
  requestChallenge(username: String!, isRegister: Boolean!): String!
  registerUser(username: String!, publicKey: String!, signature: String!, deviceId: String!): AuthPayload!
  loginUser(username: String!, signature: String!, deviceId: String!, publicKey: String): AuthPayload!
  updateUser(input: UpdateUserInput!): User!
  createTrip(input: CreateTripInput!): Trip!
  updateTrip(id: ID!, input: UpdateTripInput!): Trip!
  deleteTrip(id: ID!): Boolean!
  joinTrip(tripId: ID!, message: String, participantsCount: Int): TripParticipant!
  cancelTripJoin(tripId: ID!): TripParticipant!
  respondTripJoinRequest(tripId: ID!, userId: ID!, decision: TripJoinDecision!): TripParticipant!
  createPlace(input: CreatePlaceInput!): Place!
  updatePlace(id: ID!, input: UpdatePlaceInput!): Place!
  deletePlace(id: ID!): Boolean!
  createLocation(input: CreateLocationInput!): Location!
  updateLocation(id: ID!, input: UpdateLocationInput!): Location!
  deleteLocation(id: ID!): Boolean!
  # bookTour removed - use joinTrip instead
  createPost(input: CreatePostInput!): Post!
  createComment(postId: ID!, content: String!): Comment!
  createReaction(postId: ID, commentId: ID, emoji: String!): Reaction!
  deleteReaction(reactionId: ID!): Boolean!
  bookmarkPost(postId: ID!): Boolean!
  bookmarkTrip(tripId: ID!): Boolean!
  bookmarkPlace(placeId: ID!): Boolean!
  revokeDevice(deviceId: String!): Boolean!
  generateAvatar(style: String): User!
  # Phone and email verification mutations (for guest → member upgrade)
  requestPhoneVerification(phone: String!): Boolean!
  verifyPhone(code: String!): Boolean!
  requestEmailVerification(email: String!): Boolean!
  verifyEmail(code: String!): Boolean!
}

type Subscription {
  conversationMessages(conversationId: ID!): ChatMessage!
  newAlerts: Alert!
  tripUpdates(tripId: ID!): TripUpdate!
  feedNewEvents(filter: FeedFilter): [FeedEvent!]!
}

scalar JSON

type Conversation {
  id: ID!
  kind: String!
  tripId: ID
  title: String
  lastMessageAt: String
  members: [User!]!
  createdAt: String!
  updatedAt: String!
}

type ChatMessage {
  id: ID!
  conversationId: ID!
  senderUserId: ID!
  senderDeviceId: ID!
  type: String!
  ciphertext: String!
  ciphertextMeta: JSON
  metadata: JSON
  createdAt: String!
}

type ChatMessageEdge {
  cursor: String!
  node: ChatMessage!
}

type ChatMessageConnection {
  edges: [ChatMessageEdge!]!
  pageInfo: PageInfo!
}

type User {
  id: ID!
  name: String!
  username: String!
  email: String
  phone: String
  avatar: String
  publicKey: String
  status: String! # active, suspended, deleted
  createdAt: String!
  # User tier fields (for guest → member → pro flow)
  emailVerified: Boolean
  phoneVerified: Boolean
  hasActiveSubscription: Boolean
  subscriptionExpiresAt: String
}

type AuthPayload {
  user: User!
  token: String!
}

type Trip {
  id: ID!
  userId: ID!
  destination: String
  startDate: String
  endDate: String
  budget: Float
  travelers: Int!
  preferences: String
  accommodation: String
  status: String!
  aiReasoning: String
  itinerary: [ItineraryDay!]
  coordinates: Coordinates
  waypoints: [Waypoint!]
  # Hosted trip fields (when isHosted = true)
  isHosted: Boolean!
  title: String
  location: String
  price: Float
  currency: String
  rating: Float
  reviews: Int
  duration: Int
  durationType: String
  category: String
  difficulty: String
  description: String
  shortDescription: String
  highlights: [String!]!
  inclusions: [String!]!
  maxParticipants: Int
  minParticipants: Int
  hostIntro: String
  joinPolicy: TripJoinPolicy
  bookingInstructions: String
  imageUrl: String
  gallery: [String!]!
  tags: [String!]!
  isActive: Boolean
  isFeatured: Boolean
  externalBookingUrl: String
  # Viewer-specific fields (computed based on current user)
  viewerJoinStatus: TripJoinStatus
  createdAt: String!
  updatedAt: String!
}

enum TripJoinPolicy {
  OPEN
  REQUEST
  INVITE_ONLY
}

enum TripJoinStatus {
  NONE
  REQUESTED
  ACCEPTED
  REJECTED
  CANCELLED_BY_USER
  CANCELLED_BY_HOST
}

type TripParticipant {
  id: ID!
  tripId: ID!
  userId: ID!
  user: User
  role: TripParticipantRole!
  joinStatus: TripJoinStatus!
  notes: String
  createdAt: String!
  updatedAt: String!
}

enum TripParticipantRole {
  HOST
  CO_HOST
  MEMBER
}

enum TripJoinDecision {
  ACCEPT
  REJECT
}

type ItineraryDay {
  day: Int!
  title: String!
  activities: [String!]!
}

type Coordinates {
  latitude: Float!
  longitude: Float!
}

type Waypoint {
  latitude: Float!
  longitude: Float!
  label: String
}

input CreateTripInput {
  destination: String
  startDate: String
  endDate: String
  budget: Float
  travelers: Int!
  preferences: String
  accommodation: String
  lang: String
  coordinates: CoordinatesInput
  waypoints: [WaypointInput!]
  # Hosted trip fields
  isHosted: Boolean
  title: String
  location: String
  price: Float
  currency: String
  duration: Int
  durationType: String
  category: String
  difficulty: String
  description: String
  shortDescription: String
  highlights: [String!]
  inclusions: [String!]
  maxParticipants: Int
  minParticipants: Int
  hostIntro: String
  joinPolicy: TripJoinPolicy
  bookingInstructions: String
  imageUrl: String
  gallery: [String!]
  tags: [String!]
  isActive: Boolean
  isFeatured: Boolean
  externalBookingUrl: String
}

input UpdateTripInput {
  destination: String
  startDate: String
  endDate: String
  budget: Float
  travelers: Int
  preferences: String
  accommodation: String
  status: String
  aiReasoning: String
  itinerary: String
  userMessage: String
  lang: String
  # Hosted trip fields
  isHosted: Boolean
  title: String
  location: String
  price: Float
  currency: String
  duration: Int
  durationType: String
  category: String
  difficulty: String
  description: String
  shortDescription: String
  highlights: [String!]
  inclusions: [String!]
  maxParticipants: Int
  minParticipants: Int
  hostIntro: String
  joinPolicy: TripJoinPolicy
  bookingInstructions: String
  imageUrl: String
  gallery: [String!]
  tags: [String!]
  isActive: Boolean
  isFeatured: Boolean
  externalBookingUrl: String
}

# Tour type removed - use Trip with isHosted = true instead

type Place {
  id: ID!
  name: String!
  location: String!
  distance: Float
  rating: Float!
  reviews: Int!
  type: String!
  isOpen: Boolean!
  description: String!
  tips: [String!]!
  coordinates: Coordinates!
  phone: String
  website: String
  hours: String
  price: Int
  locationId: ID
  ownerId: ID
  imageUrl: String
  createdAt: String!
}

type Location {
  id: ID!
  name: String!
  country: String!
  description: String
  coordinates: Coordinates!
  popularActivities: [String!]!
  averageCost: Float
  bestTimeToVisit: String
  population: String
  createdAt: String!
  updatedAt: String!
}

# Booking type removed - use trip_participants table instead (Phase 10-11)

type Alert {
  id: ID!
  type: String!
  title: String!
  message: String!
  step: Int
  totalSteps: Int
  tripId: ID # Deprecated - use targetType/targetId instead (kept for backward compatibility)
  userId: ID!
  actorId: ID # Who caused the notification (nullable)
  targetType: String # Polymorphic target type: 'POST', 'TRIP', 'PLACE', 'MESSAGE', etc.
  targetId: ID # ID of the target entity
  read: Boolean
  createdAt: String!
}

type TripUpdate {
  id: ID!
  tripId: ID!
  type: String!
  title: String!
  message: String!
  step: Int!
  totalSteps: Int!
  status: String!
  data: String
  createdAt: String!
}

type Device {
  id: ID!
  deviceId: String!
  publicKey: String!
  type: String
  lastSeen: String!
  createdAt: String!
}

type Post {
  id: ID!
  userId: ID!
  user: User!
  content: String
  attachments: [String!]!
  type: String
  relatedId: ID
  relatedEntity: PostRelatedEntity
  comments: [Comment!]!
  commentsCount: Int!
  reactions: [Reaction!]!
  reactionsCount: Int!
  isBookmarked: Boolean!
  createdAt: String!
}

union PostRelatedEntity = Trip | Place

type Comment {
  id: ID!
  postId: ID!
  userId: ID!
  user: User!
  content: String!
  createdAt: String!
}

type Reaction {
  id: ID!
  postId: ID
  commentId: ID
  userId: ID!
  user: User!
  emoji: String!
  createdAt: String!
}

type Bookmark {
  id: ID!
  userId: ID!
  postId: ID
  tripId: ID
  placeId: ID
  post: Post
  trip: Trip
  place: Place
  createdAt: String!
}

type PostsConnection {
  posts: [Post!]!
  totalCount: Int!
  hasNextPage: Boolean!
  hasPreviousPage: Boolean!
  nextOffset: Int
  previousOffset: Int
}

"""
Feed types and connections for home stream
"""
enum EntityType { POST TRIP PLACE LOCATION }
enum FeedVerb { CREATED UPDATED }
enum Visibility { PUBLIC FOLLOWERS CIRCLE }

union FeedEntity = Post | Trip | Place | Location

type FeedEvent {
  id: ID!
  entityType: EntityType!
  entityId: ID!
  verb: FeedVerb!
  actor: User!
  entity: FeedEntity!
  topics: [String!]!
  visibility: Visibility!
  createdAt: String!
}

type FeedEdge { cursor: String!, node: FeedEvent! }
type PageInfo { endCursor: String, hasNextPage: Boolean! }
type FeedConnection { edges: [FeedEdge!]!, pageInfo: PageInfo! }

input FeedFilter {
  entityTypes: [EntityType!]
  topics: [String!]
  followingOnly: Boolean
  circleOnly: Boolean
  mutedUserIds: [ID!]
  visibility: [Visibility!]
  createdAtAfter: String
  createdAtBefore: String
}

type FeedPreferences {
  entityTypes: [EntityType!]!
  topics: [String!]!
  followingOnly: Boolean!
  circleOnly: Boolean!
  mutedUserIds: [ID!]!
}

extend type Query {
  getFeed(first: Int = 20, after: String, filter: FeedFilter): FeedConnection!
  getFeedPreferences: FeedPreferences!
  search(query: String!, entityTypes: [EntityType!], topics: [String!], first: Int = 20, after: String): FeedConnection!
  searchSuggest(prefix: String!, limit: Int = 10): [String!]!
  getTrending(type: TrendingType!, window: TimeWindow!, entityTypes: [EntityType!], limit: Int = 10): TrendingList!
  isFollowing(userId: ID!): Boolean!
  getFollowers(userId: ID!, first: Int = 20, after: String): [User!]!
  getFollowing(userId: ID!, first: Int = 20, after: String): [User!]!
  searchSemantic(query: String!, entityTypes: [EntityType!], first: Int = 20, after: String): FeedConnection!
}

extend type Mutation {
  updateFeedPreferences(input: FeedFilter!): FeedPreferences!
  followUser(followeeId: ID!): Boolean!
  unfollowUser(followeeId: ID!): Boolean!
  addToCloseFriends(friendId: ID!): Boolean!
  removeFromCloseFriends(friendId: ID!): Boolean!
}

"""
Trending types and windows
"""
enum TrendingType { TOPIC PLACE USER ENTITY }
enum TimeWindow { M5 H1 D1 }

type TrendingItem {
  key: String!
  label: String!
  score: Float!
  delta: Float
}

type TrendingList {
  window: TimeWindow!
  items: [TrendingItem!]!
}

# CreateTourInput and UpdateTourInput removed - use CreateTripInput/UpdateTripInput with isHosted = true

input CreatePlaceInput {
  name: String!
  location: String!
  description: String!
  type: String!
  coordinates: CoordinatesInput!
  distance: Float
  tips: [String!]
  phone: String
  website: String
  hours: String
  price: Int
  locationId: ID
  imageUrl: String
}

input UpdatePlaceInput {
  name: String
  location: String
  description: String
  type: String
  coordinates: CoordinatesInput
  distance: Float
  tips: [String!]
  phone: String
  website: String
  hours: String
  price: Int
  locationId: ID
  imageUrl: String
  isOpen: Boolean
}

input CreateLocationInput {
  name: String!
  country: String!
  description: String
  coordinates: CoordinatesInput!
  popularActivities: [String!]
  averageCost: Float
  bestTimeToVisit: String
  population: String
}

input UpdateLocationInput {
  name: String
  country: String
  description: String
  coordinates: CoordinatesInput
  popularActivities: [String!]
  averageCost: Float
  bestTimeToVisit: String
  population: String
}

# BookTourInput removed - use joinTrip mutation instead

input CreatePostInput {
  content: String
  attachments: [String!]
  type: String
  relatedId: ID
}

input UpdateUserInput {
  name: String
  username: String
  email: String
  phone: String
  avatarBase64: String
  avatarMimeType: String
}

input CoordinatesInput {
  latitude: Float!
  longitude: Float!
}

input WaypointInput {
  latitude: Float!
  longitude: Float!
  label: String
}
